import os
import pandas as pd
import dask.dataframe as dd

os.chdir(r"E:\Wejo\Wejo-Aug-Nov 2021")

files = [file for file in os.listdir() if '2021-08' in file]
list_df = [] # store df for each day

# =============================================================================
# gates specification
# =============================================================================

# 217: Speedway & Campbell (35, 35)
gate_217 = {'WB': {'g1': {'c1': [32.23622441367268, -110.94077579459487], 'c2': [32.2359004908651, -110.94174098710045]}, 
                   'g2': {'c1': [32.23628919434819, -110.94337197947992], 'c2': [32.23587130034809, -110.94457990578354]}, 
                   'g3': {'c1': [32.23627228383154, -110.94463102873335], 'c2': [32.23588925357068, -110.94554792116436]}},
            
            'EB': {'g1': {'c1': [32.23581974767533, -110.94717228344238], 'c2': [32.236246638611604, -110.9462029266629]}, 
                   'g2': {'c1': [32.23628919434819, -110.94337197947992], 'c2': [32.23587130034809, -110.94457990578354]}, 
                   'g3': {'c1': [32.23587776483134, -110.9433246954967], 'c2': [32.23624022236206, -110.94237623246346]}},
            
            'SB': {'g1': {'c1': [32.23879055073666, -110.94420072284095], 'c2': [32.23795059486595, -110.9437898174783]}, 
                   'g2': {'c1': [32.23657376304689, -110.94425290702216], 'c2': [32.23557578326345, -110.94369410495075]}, 
                   'g3': {'c1': [32.23556392170348, -110.94424646636583], 'c2': [32.23475532073333, -110.94377401346846]}},
            
            'NB': {'g1': {'c1': [32.233375669862845, -110.94380393857026], 'c2': [32.23420822807635, -110.94415003582566]}, 
                   'g2': {'c1': [32.23657376304689, -110.94425290702216], 'c2': [32.23557578326345, -110.94369410495075]}, 
                   'g3': {'c1': [32.23658657907745, -110.9437471960456], 'c2': [32.23741786976938, -110.94422783515239]}}}

# 444: Prince & 1st (35, 40)
gate_444 = {'WB': {'g1': {'c1': [32.27222362465201, -110.95796189176396], 'c2': [32.27198710309113, -110.95892896149131]}, 
                   'g2': {'c1': [32.27217601684545, -110.9605683884477], 'c2': [32.271932083673335, -110.96154378130981]}, 
                   'g3': {'c1': [32.27217679524021, -110.96156062380854], 'c2': [32.27192349304144, -110.96251795971645]}},
            
            'EB': {'g1': {'c1': [32.27195823980501, -110.96413765911582], 'c2': [32.27221202811261, -110.96316136054439]}, 
                   'g2': {'c1': [32.27217601684545, -110.9605683884477], 'c2': [32.271932083673335, -110.96154378130981]},
                   'g3': {'c1': [32.27194272090767, -110.96053666559001], 'c2': [32.272207242657615, -110.95964443519756]}},
            
            'SB': {'g1': {'c1': [32.27471002285602, -110.96122475964755], 'c2': [32.27385697751968, -110.9608973268455]}, 
                   'g2': {'c1': [32.2725041715392, -110.96121159344197], 'c2': [32.27162479703837, -110.96092868129257]}, 
                   'g3': {'c1': [32.27160552112792, -110.96121856296469], 'c2': [32.270804132239476, -110.96090675058039]}},
            
            'NB': {'g1': {'c1': [32.26942899908057, -110.96090998253067], 'c2': [32.27026397341858, -110.96120503823748]}, 
                   'g2': {'c1': [32.2725041715392, -110.96121159344197], 'c2': [32.27162479703837, -110.96092868129257]}, 
                   'g3': {'c1': [32.27250580109128, -110.9609263247134], 'c2': [32.273323640257864, -110.96118655534502]}}}

# 444: Prince & Campbell (35, 35)
gate_446 = {'WB': {'g1': {'c1': [32.27233443011584, -110.9407162765578], 'c2': [32.27215243521357, -110.94167797858722]}, 
                   'g2': {'c1': [32.27234306802247, -110.94330817050502], 'c2': [32.27209550698905, -110.94430998436584]}, 
                   'g3': {'c1': [32.27234293573983, -110.9443417000555], 'c2': [32.272095147206564, -110.94528389747875]}},
            
            'EB': {'g1': {'c1': [32.272058307081956, -110.94689564179701], 'c2': [32.2723478516684, -110.94592678779352]}, 
                   'g2': {'c1': [32.27234306802247, -110.94330817050502], 'c2': [32.27209550698905, -110.94430998436584]},
                   'g3': {'c1': [32.272137123842256, -110.9432878675613], 'c2': [32.272349246915056, -110.94233483678047]}},
            
            'SB': {'g1': {'c1': [32.27484945963481, -110.94394010530523], 'c2': [32.274030962268576, -110.94364251789517]}, 
                   'g2': {'c1': [32.272652085244815, -110.94393484432081], 'c2': [32.27180190563987, -110.94365808020484]}, 
                   'g3': {'c1': [32.2717948421036, -110.94396823303929], 'c2': [32.27096578899601, -110.94363532529805]}},
            
            'NB': {'g1': {'c1': [32.26959807969121, -110.94366999417802], 'c2': [32.270427415015895, -110.943947540603]}, 
                   'g2': {'c1': [32.272652085244815, -110.94393484432081], 'c2': [32.27180190563987, -110.94365808020484]}, 
                   'g3': {'c1': [32.27266241540712, -110.94367972799544], 'c2': [32.27347806873948, -110.94393915975111]}}}

# 540: 6th & Euclid (30, 30)
gate_540 = {'WB': {'g1': {'c1': [32.22787534329532, -110.95643472166427], 'c2': [32.227667834805494, -110.95739029163953]}, 
                   'g2': {'c1': [32.22786683851477, -110.9590202298077], 'c2': [32.2276770545877, -110.95996466707058]}, 
                   'g3': {'c1': [32.22785771762236, -110.96000630698124], 'c2': [32.22764282885227, -110.96093432629866]}},
            
            'EB': {'g1': {'c1': [32.2276598838902, -110.96254983506282], 'c2': [32.22787283394719, -110.96159703869913]}, 
                   'g2': {'c1': [32.22786683851477, -110.9590202298077], 'c2': [32.2276770545877, -110.95996466707058]}, 
                   'g3': {'c1': [32.22767223994827, -110.95898388869006], 'c2': [32.22788134518696, -110.95804483335499]}},
            
            'SB': {'g1': {'c1': [32.23039475797108, -110.95966052509783], 'c2': [32.22954621776208, -110.95934794236123]}, 
                   'g2': {'c1': [32.22816543729608, -110.95960033231741], 'c2': [32.22736970606363, -110.95936089131361]}, 
                   'g3': {'c1': [32.22734988940343, -110.95965210373903], 'c2': [32.22654513498895, -110.95937310108063]}},
            
            'NB': {'g1': {'c1': [32.225178662637646, -110.95935427051323], 'c2': [32.226001511225434, -110.95959605360883]}, 
                   'g2': {'c1': [32.22816543729608, -110.95960033231741], 'c2': [32.22736970606363, -110.95936089131361]}, 
                   'g3': {'c1': [32.22820377048179, -110.95936382554], 'c2': [32.22899479234822, -110.95960079936103]}}}

# 586: Broadway & Kolb (40, 40)
gate_586 = {'WB': {'g1': {'c1': [32.221195400741436, -110.83776241350337], 'c2': [32.220835448272155, -110.8387197650675]}, 
                   'g2': {'c1': [32.22122582726531, -110.84038590833015], 'c2': [32.22085220937155, -110.84162669146474]}, 
                   'g3': {'c1': [32.221228150751145, -110.84168399186126], 'c2': [32.22084389029241, -110.8426001663213]}},
            
            'EB': {'g1': {'c1': [32.22086129112513, -110.84422463640335], 'c2': [32.22123074522185, -110.8432484421936]}, 
                   'g2': {'c1': [32.22122582726531, -110.84038590833015], 'c2': [32.22085220937155, -110.84162669146474]}, 
                   'g3': {'c1': [32.220842718603556, -110.84030580356855], 'c2': [32.2212244552233, -110.8393959272787]}},
            
            'SB': {'g1': {'c1': [32.22376621876801, -110.84120801831949], 'c2': [32.222948735537535, -110.84079391039148]}, 
                   'g2': {'c1': [32.221571988213306, -110.84121572107593], 'c2': [32.220511022085965, -110.84077551627958]}, 
                   'g3': {'c1': [32.22048691563583, -110.84122963258093], 'c2': [32.21968878153707, -110.84076995069634]}},
            
            'NB': {'g1': {'c1': [32.21831710611116, -110.84077375217069], 'c2': [32.21914446830961, -110.84119484272112]}, 
                   'g2': {'c1': [32.221571988213306, -110.84121572107593], 'c2': [32.220511022085965, -110.84077551627958]}, 
                   'g3': {'c1': [32.22160636045579, -110.84077633468164], 'c2': [32.2224086858611, -110.84127328423834]}}}

# 618: 22nd & Kolb (40, 40)
gate_618 = {'WB': {'g1': {'c1': [32.20665295707573, -110.83771363821641], 'c2': [32.20632703858727, -110.83870841881]}, 
                   'g2': {'c1': [32.20670243885439, -110.84031785475767], 'c2': [32.2063017961023, -110.84161822309939]}, 
                   'g3': {'c1': [32.206695829289856, -110.84171789417726], 'c2': [32.20632683492474, -110.84262793587901]}},
            
            'EB': {'g1': {'c1': [32.2063236517449, -110.84424204045985], 'c2': [32.206674966270896, -110.8432816042172]}, 
                   'g2': {'c1': [32.20670243885439, -110.84031785475767], 'c2': [32.2063017961023, -110.84161822309939]}, 
                   'g3': {'c1': [32.20631734722534, -110.84023622784471], 'c2': [32.20670242953868, -110.83933236008566]}},
            
            'SB': {'g1': {'c1': [32.20925586871524, -110.84115401045611], 'c2': [32.20842481202438, -110.84078692567395]}, 
                   'g2': {'c1': [32.20703449051995, -110.84122156347183], 'c2': [32.20596230326421, -110.840747374056]}, 
                   'g3': {'c1': [32.20592518738928, -110.84121511234675], 'c2': [32.20511865991968, -110.84080256547394]}},
            
            'NB': {'g1': {'c1': [32.20379899171929, -110.84080563004564], 'c2': [32.204588403734796, -110.84116570003016]}, 
                   'g2': {'c1': [32.20703449051995, -110.84122156347183], 'c2': [32.20596230326421, -110.840747374056]}, 
                   'g3': {'c1': [32.20708441639085, -110.84076317585287], 'c2': [32.20787755518876, -110.841236151704]}}}

# =============================================================================
# geofence and filter trajectories
# =============================================================================

def geofence_trajectories(gate_spec, node, dirc):
    gate = gate_spec[dirc]
    
    # read all files in dir and filter trajectories
    for file in files:
        print(f"File: {file}")
        
        # read Wejo trajectory data
        df = dd.read_csv(file, assume_missing = True)
        
        # get unique trip IDs
        all_trips = set(df.TripID.unique())
        
        # store trip IDs passing through coordinate gates for each approach
        gate_trips = []
        
        for k in gate.keys():
            # create list of lat and lng for gate k
            lat = [gate[k]['c1'][0], gate[k]['c2'][0]]
            lng = [gate[k]['c1'][1], gate[k]['c2'][1]]
            
            # filter trip IDs passing over gate k and store the result
            trip_k = set(df[(df.Latitude.between(min(lat), max(lat))) & (df.Longitude.between(min(lng), max(lng)))].TripID.unique())
            gate_trips.append(trip_k)
            
        # intersection of sets gives IDs of common trips passing through all gates
        trips = sorted(list(set.intersection(all_trips, *gate_trips)))
        
        # filter df for trip IDs passing through all gates
        gdf = df.copy()[df.TripID.isin(trips)]
        
        # specify min-max lat and lng bounds
        lat = [gate['g1']['c1'][0], gate['g3']['c2'][0]]
        lng = [gate['g1']['c1'][1], gate['g3']['c2'][1]]
        
        # filter trips within these bounds
        gdf = gdf[(gdf.Latitude.between(min(lat), max(lat))) & (gdf.Longitude.between(min(lng), max(lng)))].compute()
        
        # remove redundant columns
        gdf.drop(['Altitude', 'unixtime', 'accuracy'], axis = 1, inplace = True)
        
        # save file
        output_path = os.path.join(r"C:\Users\pramesh\Wejo\Dilemma_Zone\raw_data", str(node) + '_' + dirc, file)
        gdf.to_csv(output_path, index = False)

# geofence trajectories for all directions
directions = ['EB', 'WB', 'NB', 'SB']
for dirc in directions:
    print(f"\nProcessing direction: {dirc}")
    # geofence_trajectories(gate_217, 217, dirc)
    # geofence_trajectories(gate_444, 444, dirc)
    # geofence_trajectories(gate_446, 446, dirc)
    # geofence_trajectories(gate_540, 540, dirc)
    # geofence_trajectories(gate_586, 586, dirc)
    # geofence_trajectories(gate_618, 618, dirc)